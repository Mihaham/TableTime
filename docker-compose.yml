services:
  database:
    build:
      context: ./database
    env_file:
      - ./database/.env
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres_password}
      - POSTGRES_DB=${POSTGRES_DB:-tabletime_db}
      - POSTGRES_APP_USER=${POSTGRES_APP_USER:-app_user}
      - POSTGRES_APP_PASSWORD=${POSTGRES_APP_PASSWORD:-app_password}
    volumes:
      - ./database/data:/var/lib/postgresql/data
      - ./database/init-game-logs.sql:/docker-entrypoint-initdb.d/init-game-logs.sql
    networks:
      - game-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  userservice:
    build:
      context: ./userservice
    ports:
      - "8002:8000"
    networks:
      - game-network

  gameengine:
    build:
      context: ./gameengine
    ports:
      - "8003:8000"
    networks:
      - game-network

  monopoly:
    build:
      context: ./games/monopoly
    depends_on:
      - gameengine
      - loggingservice
    ports:
      - "8004:8000"
    networks:
      - game-network
    environment:
      - LOGGING_SERVICE_URL=http://apigateway:8000/api/v1/logs

  rps:
    build:
      context: ./games/rps
    depends_on:
      - gameengine
      - loggingservice
    ports:
      - "8006:8000"
    networks:
      - game-network
    environment:
      - LOGGING_SERVICE_URL=http://apigateway:8000/api/v1/logs

  diceladders:
    build:
      context: ./games/diceladders
    depends_on:
      - gameengine
      - loggingservice
    ports:
      - "8008:8000"
    networks:
      - game-network
    environment:
      - LOGGING_SERVICE_URL=http://apigateway:8000/api/v1/logs

  loggingservice:
    build:
      context: ./games/loggingservice
    depends_on:
      database:
        condition: service_healthy
    ports:
      - "8007:8000"
    networks:
      - game-network
    environment:
      - POSTGRES_APP_USER=${POSTGRES_APP_USER:-app_user}
      - POSTGRES_APP_PASSWORD=${POSTGRES_APP_PASSWORD:-app_password}
      - POSTGRES_DB=${POSTGRES_DB:-tabletime_db}
      - POSTGRES_HOST=database

  apigateway:
    build:
      context: ./apigateway
    depends_on:
      - userservice
      - gameengine
      - monopoly
      - rps
      - diceladders
      - loggingservice
    ports:
      - "8000:8000"
    networks:
      - game-network
    environment:
      - USER_SERVICE_URL=http://userservice:8000
      - GAME_ENGINE_SERVICE_URL=http://gameengine:8000
      - MONOPOLY_SERVICE_URL=http://monopoly:8000
      - RPS_SERVICE_URL=http://rps:8000
      - DICELADDERS_SERVICE_URL=http://diceladders:8000
      - LOGGING_SERVICE_URL=http://loggingservice:8000

  telegrambot:
    build:
      context: ./telegrambot
    env_file:
      - ./telegrambot/.env
    # Remove environment override - let env_file handle it
    # If TOKEN needs to be overridden, uncomment and set it here
    # environment:
    #   - TOKEN=${TOKEN}
    depends_on:
      - apigateway
      - userservice
    networks:
      - game-network
    # Uncomment to disable telegrambot if not needed
    # profiles:
    #   - disabled

networks:
  game-network:
    driver: bridge